# Grok API Triggers - Complete Summary

**Last Updated:** December 2024  
**Status:** All triggers configured and active

---

## Overview

This document lists all triggers that call the Grok API (X.AI) to fetch stories or generate content. There are two main types:
1. **Scheduled Triggers** - Automatic, time-based fetches
2. **Manual Triggers** - On-demand API calls from admin dashboard

---

## üîÑ Scheduled Triggers (Cloud Scheduler)

These run automatically at specified intervals using Firebase Cloud Scheduler.

### 1. **Trending Stories** (`scheduledGrokFetchTrending`)
- **Schedule:** Every 1 hour
- **Time Zone:** Africa/Lagos (WAT)
- **Category:** `Trending Stories`
- **Function:** `scheduledFetch(GrokCategory.TRENDING)`
- **Auto-Draft:** Enabled (if configured)
- **Secrets:** `XAI_API_KEY`
- **Status:** ‚úÖ Active

### 2. **Breaking News** (`scheduledGrokFetchBreaking`)
- **Schedule:** Every 30 minutes
- **Time Zone:** Africa/Lagos (WAT)
- **Category:** `Breaking News`
- **Function:** `scheduledFetch(GrokCategory.BREAKING_NEWS)`
- **Business Hours:** Only runs 8 AM - 8 PM WAT
- **Auto-Draft:** Enabled (if configured)
- **Secrets:** `XAI_API_KEY`
- **Memory:** 256MiB
- **Max Instances:** 1
- **Status:** ‚úÖ Active

### 3. **Company News** (`scheduledGrokFetchCompany`)
- **Schedule:** Every 2 hours
- **Time Zone:** Africa/Lagos (WAT)
- **Category:** `Company News`
- **Function:** `scheduledFetch(GrokCategory.COMPANY_NEWS)`
- **Auto-Draft:** Enabled (if configured)
- **Secrets:** `XAI_API_KEY`
- **Status:** ‚úÖ Active

### 4. **Funding & Investments** (`scheduledGrokFetchFunding`)
- **Schedule:** Every 4 hours
- **Time Zone:** Africa/Lagos (WAT)
- **Category:** `Funding & Investments`
- **Function:** `scheduledFetch(GrokCategory.FUNDING)`
- **Auto-Draft:** Enabled (if configured)
- **Secrets:** `XAI_API_KEY`
- **Status:** ‚úÖ Active

### üìã Available Categories (Not Scheduled)

These categories can be fetched manually via the API endpoint but don't have scheduled triggers:

- **Product Launches & Reviews** - Available for manual fetch
- **Regulatory & Policy Changes** - Available for manual fetch
- **Security & Hacking** - Available for manual fetch
- **Emerging Technologies** - Available for manual fetch

---

## üéØ Manual Triggers (API Endpoints)

These are triggered manually from the admin dashboard or via API calls.

### 1. **Manual Fetch Stories** (`POST /api/v1/grok-trends/fetch`)
- **Endpoint:** `POST /api/v1/grok-trends/fetch`
- **Handler:** `fetchGrokStories()`
- **Authentication:** Admin required
- **Parameters:**
  - `category` (optional) - Specific category to fetch. Options:
    - `Breaking News`
    - `Trending Stories` (default)
    - `Company News`
    - `Product Launches & Reviews`
    - `Funding & Investments`
    - `Regulatory & Policy Changes`
    - `Security & Hacking`
    - `Emerging Technologies`
  - `autoGenerateDrafts` (optional, default: false) - Auto-generate drafts
  - `engagementThreshold` (optional, default: 5000) - Threshold for auto-draft
- **Grok API Call:** ‚úÖ Yes - Calls `callGrokAPI()` with category-specific prompt
- **Returns:** Number of stories fetched, stored, skipped, and drafts generated
- **Status:** ‚úÖ Active

### 2. **Generate Draft** (`POST /api/v1/grok-trends/stories/:id/generate-draft`)
- **Endpoint:** `POST /api/v1/grok-trends/stories/:id/generate-draft`
- **Handler:** `generateDraft()`
- **Authentication:** Admin required
- **Grok API Call:** ‚úÖ Yes - Calls `callGrokAPI()` with draft generation prompt
- **Purpose:** Generate AI-powered blog post draft from a Grok story
- **Returns:** Draft content (title, content, excerpt, tags, meta fields)
- **Status:** ‚úÖ Active

---

## ü§ñ Auto-Draft Generation (Within Scheduled Fetches)

Auto-draft generation happens automatically during scheduled fetches if configured.

### Configuration
- **Config Location:** Firestore `grok_config/auto_draft`
- **Settings:**
  - `enabled` - Enable/disable auto-draft
  - `engagementThreshold` - Minimum engagement score (default: 5000)
  - `categories` - Categories to enable auto-draft for (empty = all)

### How It Works
1. Scheduled fetch runs and stores stories
2. For each story with `engagement_score >= engagementThreshold`:
   - Calls `autoGenerateDraft()` function
   - `autoGenerateDraft()` calls `callGrokAPI()` with draft generation prompt
   - Draft is stored in story document
   - Story status updated to `draft_created`

### Triggered By
- ‚úÖ `scheduledGrokFetchTrending` (if enabled)
- ‚úÖ `scheduledGrokFetchBreaking` (if enabled)
- ‚úÖ `scheduledGrokFetchCompany` (if enabled)
- ‚úÖ `scheduledGrokFetchFunding` (if enabled)
- ‚úÖ `fetchGrokStories()` manual fetch (if `autoGenerateDrafts: true`)

---

## üìä Grok API Call Summary

### Functions That Call Grok API

| Function | When Called | Purpose |
|----------|-------------|---------|
| `callGrokAPI()` | Core function - called by all triggers | Makes HTTP request to X.AI API |
| `fetchGrokStories()` | Manual fetch endpoint | Fetch stories from X (Twitter) |
| `scheduledFetch()` | All scheduled triggers | Fetch stories (with optional auto-draft) |
| `generateDraft()` | Manual draft generation | Generate blog post draft |
| `autoGenerateDraft()` | During scheduled fetch | Auto-generate draft for high-engagement stories |

### API Endpoint
- **URL:** `https://api.x.ai/v1/chat/completions`
- **Model:** `grok-3` (configurable via `GROK_MODEL` env var)
- **Authentication:** Bearer token (`XAI_API_KEY`)
- **Response Format:** JSON

---

## üîß Configuration

### Required Secrets
- `XAI_API_KEY` - X.AI API key (required for all Grok operations)

### Environment Variables (Optional)
- `GROK_MODEL` - Model name (default: `grok-3`, `grok-beta` was deprecated on 2025-09-15)
- `GROK_API_URL` - API endpoint (default: X.AI endpoint)

### Auto-Draft Config (Firestore)
- Collection: `grok_config`
- Document: `auto_draft`
- Fields:
  - `enabled` (boolean)
  - `engagementThreshold` (number)
  - `categories` (string[])

---

## üìà Daily Grok API Call Estimates

Based on current schedule:

| Trigger | Frequency | Calls/Day | Notes |
|---------|-----------|-----------|-------|
| Trending Stories | Every 1 hour | 24 | Runs 24/7 |
| Breaking News | Every 30 min | ~24 | Only 8 AM - 8 PM (12 hours) |
| Company News | Every 2 hours | 12 | Runs 24/7 |
| Funding | Every 4 hours | 6 | Runs 24/7 |
| **Total Fetch Calls** | | **~66** | Per day |
| **Draft Generation** | Variable | **~0-66** | Depends on engagement threshold |

**Note:** Each fetch call = 1 Grok API call. Each auto-draft = 1 additional Grok API call.

---

## üéõÔ∏è Managing Triggers

### View Scheduled Functions
```bash
firebase functions:list
```

### View Logs
```bash
firebase functions:log --only scheduledGrokFetchTrending
firebase functions:log --only scheduledGrokFetchBreaking
firebase functions:log --only scheduledGrokFetchCompany
firebase functions:log --only scheduledGrokFetchFunding
```

### Pause a Scheduled Function
Edit `functions/index.js` and comment out the export, then redeploy:
```bash
firebase deploy --only functions:scheduledGrokFetchTrending
```

### Test Manual Fetch
```bash
curl -X POST https://us-central1-techblit.cloudfunctions.net/api/v1/grok-trends/fetch \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"category": "Trending Stories"}'
```

---

## ‚úÖ Status Checklist

- [x] All 4 scheduled triggers configured
- [x] Manual fetch endpoint active
- [x] Draft generation endpoint active
- [x] Auto-draft generation implemented
- [x] All triggers use Firebase Secrets (`XAI_API_KEY`)
- [x] Error handling implemented
- [x] Logging configured
- [x] Deduplication logic active

---

## üìù Notes

1. **Breaking News** only runs during business hours (8 AM - 8 PM WAT) to reduce API costs
2. **Auto-draft** can significantly increase API calls - monitor engagement threshold
3. All triggers include error handling and logging
4. Stories are deduplicated by `x_post_ids` to avoid duplicates
5. Scheduled functions use Cloud Scheduler (Firebase Functions v2)

---

**Total Grok Triggers:** 6 (4 scheduled + 2 manual)

